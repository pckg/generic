<script type="text/x-template" id="vue-pckg-select">
    <div class="pckg-select">
        <select v-if="multiple" class="form-control" multiple v-model="selectedMultiple"
                data-live-search="true">
            <option v-for="(option, key) in finalOptions" :value="key" v-html="option"></option>
            <optgroup v-for="(optgroup, label) in finalOptionGroups" :label="label">
                <option v-for="(option, key) in optgroup" :value="key" v-html="option"></option>
            </optgroup>
        </select>
        <select v-else class="form-control" v-model="selectedSingle"
                data-live-search="true">
            <option v-for="(option, key) in finalOptions" :value="key" v-html="option"></option>
            <optgroup v-for="(optgroup, label) in finalOptionGroups" :label="label">
                <option v-for="(option, key) in optgroup" :value="key" v-html="option"></option>
            </optgroup>
        </select>
    </div>
</script>

<script>

    Vue.component('pckg-select', {
        mixins: [pckgDelimiters, pckgTimeout],
        name: 'pckg-select',
        template: '#vue-pckg-select',
        model: {
            prop: 'selected',
            event: 'input'
        },
        data: function () {
            return {
                options: this.initialOptions,
                selectedMultiple: Array.isArray(this.selected) ? this.selected : [this.selected],
                selectedSingle: this.selected,
            };
        },
        props: {
            withEmpty: {
                default: true
            },
            initialOptions: {
                default: function () {
                    return [];
                }
            },
            selected: {
                default: function () {
                    return [];
                }
            },
            initialMultiple: {
                default: true,
                type: Boolean
            },
            refreshUrl: {
                type: String,
                default: ''
            }
        },
        computed: {
            finalOptions: function () {
                var options = {'': ' -- select value -- '};

                $.each(this.options, function (key, item) {
                    if (typeof item != 'string') {
                        return;
                    }

                    options[key] = item;
                });

                return options;
            },
            finalOptionGroups: function () {
                var options = {};
                $.each(this.options, function (key, item) {
                    if (typeof item == 'string') {
                        return;
                    }

                    options[key] = item;
                });

                return options;
            },
            multiple: function () {
                return this.initialMultiple;
            }
        },
        watch: {
            selected: function (newVal) {
                this.$emit('input', newVal);
            },
            selectedMultiple: function (newVal) {
                this.$emit('input', newVal);
            },
            selectedSingle: function (newVal) {
                this.$emit('input', newVal);
            },
            options: function (newVal) {
                console.log('options watcher: options changed');
                Vue.nextTick(function () {
                    console.log('refreshing selectpicker');
                    $(this.$el).find('select').selectpicker('refresh');
                }.bind(this));
            }
        },
        methods: {
            refreshList: function () {
                this.timeout('refreshList', function () {
                    if (this.refreshUrl.length == 0) {
                        console.log("no refresh url");
                        return;
                    }

                    http.getJSON(this.refreshUrl + '?search=' + $(this.$el).find('.bs-searchbox input').val(), function (data) {
                        this.options = data.records;
                    }.bind(this));
                }.bind(this), 333);
            }
        },
        mounted: function () {
            this.$nextTick(function () {
                $(this.$el).find('select').selectpicker({
                    liveSearch: true
                });

                $(this.$el).find('select').selectpicker('refresh');

                /*$(this.$el).find('select').on('change', function () {
                 console.log('changing', $(this.$el).find('select').val());
                 this.$emit('input', $(this.$el).find('select').val());
                 }.bind(this));*/

                $(this.$el).find('.bs-searchbox input').on('keyup', function () {
                    this.refreshList();
                }.bind(this));
            });

            /**
             * Initial fetch.
             */
            if (this.options.length == 0 && this.refreshUrl.length > 0) {
                this.refreshList();
            }
        }
    });
</script>